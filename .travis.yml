# language target
language: cpp
compiler: gcc

# main build matrix
matrix:
  include:
    - name: "Xenial Ubuntu Linux"
      os: linux
      dist: xenial
      sudo: required
      env: TARGETOS=xenial-linux

# install, install QT5.12.3 from ppa
install:
  - sudo add-apt-repository -y ppa:beineri/opt-qt-5.12.3-xenial 
  - sudo apt update --assume-yes --force-yes
  - sudo apt install build-essential g++ make ffmpeg sox libnotify-dev mesa-common-dev libpulse-dev libpulse-mainloop-glib0 desktop-file-utils --assume-yes --force-yes
  - sudo apt install qt-latest tree --assume-yes --force-yes
  - echo "/opt/qt512/bin" | sudo tee /etc/xdg/qtchooser/default.conf
  - echo "/opt/qt512/lib" | sudo tee -a /etc/xdg/qtchooser/default.conf
  - qtchooser -print-env
  - qmake -v
  - sudo apt install qtdeclarative5-dev qtmultimedia5-dev --assume-yes --force-yes

# build & test scripts
script:
  - qmake mystiq.pro
  - make
  - sudo make install

# make the AppImage bundle
before_deploy:
  - wget -c -nv https://github.com/$(wget -q https://github.com/probonopd/go-appimage/releases -O - | grep "appimagetool-.*-x86_64.AppImage" | head -n 1 | cut -d '"' -f 2)
  - chmod +x ./appimagetool-*.AppImage
  - ./appimagetool-*.AppImage deploy AppDir/usr/share/applications/*.desktop
  - ./appimagetool-*.AppImage AppDir/

branches:
  except:
    - # Do not build tags that we create when we upload to GitHub Releases
    - /^(?i:continuous)/
